// PRELOADER
$(window).on('load', function () {
  $('#preloader').delay(300).fadeOut('slow');
});

class adminClass {
  http = new xhr();
  submitNotifForm() {
    var regexpForUrl = /^(?:(?:https?|ftp):\/\/)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/\S*)?$/;
    var data = new FormData();
    var type = document.getElementById("selectTypeOfNotif");
    var label = document.getElementById("batchForNotif");
    var text = document.getElementById("notifText");
    if (!(type.value == "D" || type.value == "N" || type.value == "C")) {
      type.classList.add("is-invalid");
      return false;
    } else {
      type.classList.remove("is-invalid");
      data.append("type", type.value);
    }
    if (
      $("input[name=batchForNotif]:checked").val() == "new" ||
      $("input[name=batchForNotif]:checked").val() == "imp" ||
      $("input[name=batchForNotif]:checked").val() == "na"
    ) {
      label.classList.remove("is-invalid");
      data.append("label", $("input[name=batchForNotif]:checked").val());
    } else {
      label.classList.add("is-invalid");
      return false;
    }
    if (text.value.trim().length > 7) {
      text.classList.remove("is-invalid");
      data.append("text", text.value);
    } else {
      text.classList.add("is-invalid");
      return false;
    }

    if (document.getElementById("notifFileSelect").value != "") {
      data.append("isfile", 1);
      data.append("file", document.getElementById("notifFileSelect").files[0]);
    } else {
      if (document.getElementById("notifUrl").value != "") {
        if (regexpForUrl.test(document.getElementById("notifUrl").value)) {
          data.append("url", document.getElementById("notifUrl").value);
          document.getElementById("notifUrl").classList.remove("is-invalid");
        } else {
          document.getElementById("notifUrl").classList.add("is-invalid");
        }
      }
    }
    data.append("request", "new");
    this.http.post(
      "/api/admin/notifications/",
      data,
      admin.listenSubmitModalForm,
      ['notifSendBtn', 'infoNotifManage']
    );
    document.getElementById("notifSendBtn").disabled = true;
  }
  deleteNotif(id) {
    if (isNaN(id)) return false;
    var conf = confirm("Do you really want to delete ?");
    if (conf == true) {
      var data = new FormData();
      data.append("consent", 1);
      data.append("id", id);
      data.append("request", 'del');
      this.http.post("/api/admin/notifications/", data, admin.listenSubmitModalForm, ['notifSendBtn', 'infoNotifManage']);
    } else {
      return false;
    }
  }
  editAboutInfo() {
    var abt1 = document.getElementById('aboutPara1');
    var abt2 = document.getElementById('aboutPara2');
    if(abt1.value.trim().length < 10) {
      alert("About 1 Paragraph too short.");
      return false;
    }
    if(abt2.value.trim().length < 10) {
      alert("About 2 Paragraph too short.");
      return false;
    }
    var data = new FormData();
    data.append("request", "about-edit");
    data.append("abt1", abt1.value); 
    data.append("abt2", abt2.value);
    this.http.post("/api/admin/site-basics/", data, admin.listenSubmitModalForm, ['editAboutBtn', 'infoSettingsDialog']) 
  } 
  addExam() {
    var examName = document.getElementById("examName");
    if(examName.value.trim().length < 3) {
      document.getElementById('infoResultDialog').innerHTML = "<p class='text-info'>Please enter exam name with at least 3 characters</p>";
      return false;
    } 
    document.getElementById('infoResultDialog').innerHTML = "";
    var data = new FormData();
    data.append("request", "add-exam");
    data.append("exam-name", examName.value);
    this.http.post("/api/admin/results/", data, admin.listenSubmitModalForm, ["createExamBtn", "infoResultDialog"]);
    document.getElementById("createExamBtn").disabled = true;
  }
  listenSubmitModalForm(status, res, extra) {
    document.getElementById(extra[0]).disabled = false;
    try {
      var res = JSON.parse(res);
    } catch {
      console.log(status, res);
      var html =
        '<p class="text-danger">Something Went Wrong Please Check Console for more Information</p>';

      document.getElementById(extra[1]).innerHTML = html;
      return false;
    }
    if (status == 200) {
      if (res.code == 200) {
        var html = "<p class='text-success'>" + res.message + "</p>";
        document.getElementById("notifSendForm").reset();
      } else if (res.code == 201) {
        var html =
          "<p class='text-danger'>Some Error Occurred!!! Please check the fields and try again. Error Msg : "+res.message+"</p>";
      } else if(res.code == 400) {
        var html = "<p class='text-danger'>Bad request, please contact administrator with message - "+res.message;
      } else {
        console.log(res);
        var html = "<p class='text-danger'>" + res.message + "</p>";
      }
    } else if (status == 0) {
      var html =
        "<p class='text-danger'>Failed to connect with server, check internet connection</p>";
    } else if (status == 403) {
      var html =
        "<p class='text-danger'>" +
        res.code +
        " : " +
        res.message +
        " <a href='/admin/'> Login Here</a></p>";
    } else {
      console.log(res);
      var html =
        "<p class='text-danger'>Error : " +
        status +
        " : " +
        res.message +
        "</p>";
    }
    document.getElementById(extra[1]).innerHTML = html;
  }
}
var http = new xhr();
var admin = new adminClass();


