// PRELOADER
$(window).on('load', function () {
  $('#preloader').delay(300).fadeOut('slow');
});

class adminClass {
  http = new xhr();
  submitNotifForm() {
    var regexpForUrl = /^(?:(?:https?|ftp):\/\/)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/\S*)?$/;
    var data = new FormData();
    var type = document.getElementById("selectTypeOfNotif");
    var label = document.getElementById("batchForNotif");
    var text = document.getElementById("notifText");
    if (!(type.value == "D" || type.value == "N" || type.value == "C")) {
      type.classList.add("is-invalid");
      return false;
    } else {
      type.classList.remove("is-invalid");
      data.append("type", type.value);
    }
    if (
      $("input[name=batchForNotif]:checked").val() == "new" ||
      $("input[name=batchForNotif]:checked").val() == "imp" ||
      $("input[name=batchForNotif]:checked").val() == "na"
    ) {
      label.classList.remove("is-invalid");
      data.append("label", $("input[name=batchForNotif]:checked").val());
    } else {
      label.classList.add("is-invalid");
      return false;
    }
    if (text.value.trim().length > 7) {
      text.classList.remove("is-invalid");
      data.append("text", text.value);
    } else {
      text.classList.add("is-invalid");
      return false;
    }

    if (document.getElementById("notifFileSelect").value != "") {
      data.append("isfile", 1);
      data.append("file", document.getElementById("notifFileSelect").files[0]);
    } else {
      if (document.getElementById("notifUrl").value != "") {
        if (regexpForUrl.test(document.getElementById("notifUrl").value)) {
          data.append("url", document.getElementById("notifUrl").value);
          document.getElementById("notifUrl").classList.remove("is-invalid");
        } else {
          document.getElementById("notifUrl").classList.add("is-invalid");
        }
      }
    }
    data.append("request", "new");
    this.http.post(
      "/api/admin/notifications/",
      data,
      admin.listenSubmitModalForm,
      ['notifSendBtn', 'infoNotifManage']
    );
    document.getElementById("notifSendBtn").disabled = true;
  }
  deleteNotif(id) {
    if (isNaN(id)) return false;
    var conf = confirm("Do you really want to delete ?");
    if (conf == true) {
      var data = new FormData();
      data.append("consent", 1);
      data.append("id", id);
      data.append("request", 'del');
      this.http.post("/api/admin/notifications/", data, admin.listenSubmitModalForm, ['notifSendBtn', 'infoNotifManage']);
    } else {
      return false;
    }
  }
  editAboutInfo() {
    var abt1 = document.getElementById('aboutPara1');
    var abt2 = document.getElementById('aboutPara2');
    if(abt1.value.trim().length < 10) {
      alert("About 1 Paragraph too short.");
      return false;
    }
    if(abt2.value.trim().length < 10) {
      alert("About 2 Paragraph too short.");
      return false;
    }
    var data = new FormData();
    data.append("request", "about-edit");
    data.append("abt1", abt1.value); 
    data.append("abt2", abt2.value);
    this.http.post("/api/admin/site-basics/", data, admin.listenSubmitModalForm, ['editAboutBtn', 'infoSettingsDialog']) 
  } 
  addExam() {
    var examName = document.getElementById("examName");
    if(examName.value.trim().length < 3) {
      document.getElementById('infoResultDialog').innerHTML = "<p class='text-info'>Please enter exam name with at least 3 characters</p>";
      return false;
    } 
    document.getElementById('infoResultDialog').innerHTML = "";
    var data = new FormData();
    data.append("request", "add-exam");
    data.append("exam-name", examName.value);
    this.http.post("/api/admin/results/", data, admin.listenSubmitModalForm, ["createExamBtn", "infoResultDialog"]);
    document.getElementById("createExamBtn").disabled = true;
  }
  deleteExam() {
    var examId = document.getElementById("selectExamInDel");
    var conf = confirm("Do you really want to delete selected exam ?");
    if(conf == false) {
      return false;
    } 
    if((!isNaN(examId.value)) && (!(examId.value == ""))) {
      var data = new FormData();
    } else {
      alert("Select exam first");
      return false;
    }
    data.append("request", "deleteExam");
    data.append("examId", examId.value);
    data.append("conf", 1);
    this.http.post("/api/admin/results/", data, admin.listenSubmitModalForm, ['deleteExamBtn', 'infoResultDialog']);
  }
  addResult() {
    var examId = document.getElementById("selectExamInResultUpload");
    var rollNo = document.getElementById("rollNoInRes");
    var dob = document.getElementById("dobInRes");
    if(!((!isNaN(examId.value)) && (!(examId.value == "")))) { 
      alert("Select Exam");
      return false;
    } 
    if(rollNo.value.trim().length < 3) {
      alert("Please Enter Roll Number");
    }
    var data = new FormData();
    data.append("request", "addResult");
    data.append("examId", examId.value);
    data.append("rollNo", rollNo.value);
    data.append("dob", dob.value);
    data.append("file", document.getElementById("selectResFile").files[0]);
    this.http.post("/api/admin/results/", data, admin.listenSubmitModalForm, ['addResultBtn', 'infoResultDialog']);
  }
  editSlideShow() {
    var data = new FormData();
    data.append("request", "slideshow-edit");
    data.append("slide_1_url", document.getElementById("slide1Url").value);
    data.append("slide_2_url", document.getElementById("slide2Url").value);
    data.append("slide_3_url", document.getElementById("slide3Url").value);
    data.append("slide_1_title", document.getElementById("slide1Title").value);
    data.append("slide_2_title", document.getElementById("slide2Title").value);
    data.append("slide_3_title", document.getElementById("slide3Title").value);
    data.append("slide_1_info", document.getElementById("slide1Desc").value);
    data.append("slide_2_info", document.getElementById("slide2Desc").value);
    data.append("slide_3_info", document.getElementById("slide3Desc").value);
    this.http.post("/api/admin/site-basics/", data, admin.listenSubmitModalForm, ['editSlidesBtn', 'infoSettingsDialog']) 
   
  }
  addCourse() {
    var data = new FormData();
    data.append("request", "add-course");
    data.append("cName", document.getElementById("addCourseName").value);
    data.append("cElg", document.getElementById("addCourseEligibility").value);
    data.append("cDur", document.getElementById("addCourseDuration").value);
    data.append("cFees", document.getElementById("addExamFees").value);
    this.http.post("/api/admin/courses/", data, admin.listenSubmitModalForm, ['addCourseBtn', 'infoCourseDialog']);
  }
  editCourse() {
    var cid = document.getElementById("courseListInEditCourses").value;
    try {
      if(course.courses[cid].course_id == cid) 
      void(0);
    } catch {
      alert("Invalid Course Selected");
      return false;
    }
    var data = new FormData();
    data.append("request", "edit-course");
    data.append("cid", cid);
    data.append("cName", document.getElementById("editCourseName").value);
    data.append("cElg", document.getElementById("editCourseEligibility").value);
    data.append("cDur", document.getElementById("editCourseDuration").value);
    data.append("cFees", document.getElementById("editExamFees").value);
    this.http.post("/api/admin/courses/", data, admin.listenSubmitModalForm, ['editCourseBtn', 'infoCourseDialog']);
  }
  resetSelectedCourse() {
    document.getElementById("editCourseName").disabled = true;
    document.getElementById("editCourseEligibility").disabled = true;
    document.getElementById("editCourseDuration").disabled = true;
    document.getElementById("editExamFees").disabled = true;
    document.getElementById("deleteCourseBtn").disabled = true;
    document.getElementById("editCourseBtn").disabled = true;
    document.getElementById("editCourseName").value = "";
    document.getElementById("editCourseEligibility").value = "";
    document.getElementById("editCourseDuration").value = "";
    document.getElementById("editExamFees").value = "";
  }
  deleteCourse() { 
    var cid = document.getElementById("courseListInEditCourses").value;
    try {
      if(course.courses[cid].course_id == cid) 
      void(0);
    } catch {
      alert("Invalid Course Selected");
      return false;
    }
    var c = confirm("Do you Really Want to Delete - "+course.courses[cid].course_name);
    if(c == false) {
      this.resetSelectedCourse();
      return false;
    }
    var data = new FormData();
    data.append("request", "delete-course");
    data.append("cid", cid);
    this.http.post("/api/admin/courses/", data, admin.listenSubmitModalForm, ['deleteCourseBtn', 'infoCourseDialog']);


  }
  courseSelected(cid) {
    admin.resetSelectedCourse();
    if(cid == "") {
      return false;
    }
    try {
      if(course.courses[cid].course_id == cid) 
      void(0);
    } catch {
      alert("Invalid Course Selected");
      return false;
    }
    document.getElementById("editCourseName").disabled = false;
    document.getElementById("editCourseEligibility").disabled = false;
    document.getElementById("editCourseDuration").disabled = false;
    document.getElementById("editExamFees").disabled = false;
    document.getElementById("deleteCourseBtn").disabled = false;
    document.getElementById("editCourseBtn").disabled = false;
    document.getElementById("editCourseName").value = course.courses[cid].course_name;
    document.getElementById("editCourseEligibility").value = course.courses[cid].eligibility;
    document.getElementById("editCourseDuration").value = course.courses[cid].duration;
    document.getElementById("editExamFees").value = course.courses[cid].exam_fees;
  }
  listenSubmitModalForm(status, res, extra) {
    document.getElementById(extra[0]).disabled = false;
    try {
      var res = JSON.parse(res);
    } catch {
      console.log(status, res);
      var html =
        '<p class="text-danger">Something Went Wrong Please Check Console for more Information</p>';

      document.getElementById(extra[1]).innerHTML = html;
      return false;
    }
    if (status == 200) {
      if (res.code == 200) {
        var html = "<p class='text-success'>" + res.message + "</p>";
      } else if (res.code == 201) {
        var html =
          "<p class='text-danger'>Some Error Occurred!!! Please check the fields and try again. Error Msg : "+res.message+"</p>";
      } else if(res.code == 400) {
        var html = "<p class='text-danger'>Bad request, please contact administrator with message - "+res.message;
      } else {
        console.log(res);
        var html = "<p class='text-danger'>" + res.message + "</p>";
      }
    } else if (status == 0) {
      var html =
        "<p class='text-danger'>Failed to connect with server, check internet connection</p>";
    } else if (status == 403) {
      var html =
        "<p class='text-danger'>" +
        res.code +
        " : " +
        res.message +
        " <a href='/admin/'> Login Here</a></p>";
    } else {
      console.log(res);
      var html =
        "<p class='text-danger'>Error : " +
        status +
        " : " +
        res.message +
        "</p>";

    }
    document.getElementById(extra[1]).innerHTML = html;
    try {
      eval(res.func);
    }
    catch {
      void(0);
    }
  }
}
var http = new xhr();
var admin = new adminClass();


